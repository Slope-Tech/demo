(()=>{var e={7700:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(9713)),c=n(r(1051)),s=n(r(5292)),u=n(r(2721)),l=r(8184),f=r(1582);function d(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function h(e){for(var t=1;t<arguments.length;t++){var r=null!=arguments[t]?arguments[t]:{};t%2?d(Object(r),!0).forEach((function(t){(0,a.default)(e,t,r[t])})):Object.getOwnPropertyDescriptors?Object.defineProperties(e,Object.getOwnPropertyDescriptors(r)):d(Object(r)).forEach((function(t){Object.defineProperty(e,t,Object.getOwnPropertyDescriptor(r,t))}))}return e}var p=["site","serviceName","methodName"],v=["actionId"],b=function(){function e(){var t=arguments.length>0&&void 0!==arguments[0]?arguments[0]:{};(0,i.default)(this,e),this.context=h({},t)}return(0,o.default)(e,[{key:"merge",value:function(t){if(!t)return this;if(t instanceof e.Builder)throw new Error("KatalMetricsContext.Builder object passed instead of KatalMetricsContext.  Try calling .build() method.");var r=t instanceof e?t.context:t;return new e(h(h(h({},this.context),r),{},{relatedMetrics:(0,l.mergeLists)(this.context.relatedMetrics,r.relatedMetrics),relatedMetricsSingleAction:(0,l.mergeLists)(this.context.relatedMetricsSingleAction,r.relatedMetricsSingleAction),cloudWatchDimensions:(0,l.mergeLists)(this.context.cloudWatchDimensions,r.cloudWatchDimensions)}))}},{key:"withoutRelatedMetricsSingleAction",value:function(){return new e(h(h({},this.context),{},{relatedMetricsSingleAction:void 0}))}},{key:"driverContext",value:function(){var t=h({},this.context);return delete t.relatedMetrics,delete t.relatedMetricsSingleAction,delete t.requestId,this.context.requestId&&(t.actionId=(0,f.embedRequestId)(t.actionId,this.context.requestId)),new e(t)}},{key:"getFields",value:function(){return h({},this.context)}},{key:"validationError",value:function(){var e,t=this;return(e=(0,u.default)(p,(function(e){if(null==t.context[e])return new Error("Field ".concat(e," is required, but it is ").concat(t.context[e]))})))?e:(v.forEach((function(e){if(!t.context[e]){var r,n=new CustomEvent("katal.metrics.missing-".concat(e),{detail:{context:t.context}});null===(r=window)||void 0===r||r.dispatchEvent(n),console.warn("No ".concat(e," present in context."))}})),(0,u.default)(Object.keys(this.context),(function(e){return t.validateField(e)})))}},{key:"validateField",value:function(e){var t=this.context[e],r="field ".concat(e);switch(e){case"site":case"serviceName":if(t.indexOf("/")>-1)return new Error("Expected ".concat(r," to contain only valid characters, but it was ").concat(t,".  It cannot contain a slash."));case"methodName":case"actionId":return(0,c.default)(t,r);case"cloudWatchDimensions":return(0,s.default)(t||[])}}}]),e}();t.default=b,(0,a.default)(b,"Builder",function(){function e(){(0,i.default)(this,e),(0,a.default)(this,"context",{})}return(0,o.default)(e,[{key:"withSite",value:function(e){return this.context.site=e,this}},{key:"withServiceName",value:function(e){return this.context.serviceName=e,this}},{key:"withMethodName",value:function(e){return this.context.methodName=e,this}},{key:"withActionId",value:function(e){return this.context.actionId=e,this}},{key:"withRequestId",value:function(e){return this.context.requestId=e,this}},{key:"withCloudWatchDimensions",value:function(e){return this.context.cloudWatchDimensions=e,this}},{key:"withRelatedMetrics",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.context.relatedMetrics=t,this}},{key:"addRelatedMetrics",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.context.relatedMetrics=(0,l.mergeLists)(this.context.relatedMetrics,t),this}},{key:"withRelatedMetricsSingleAction",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.context.relatedMetricsSingleAction=t,this}},{key:"addRelatedMetricsSingleAction",value:function(){for(var e=arguments.length,t=new Array(e),r=0;r<e;r++)t[r]=arguments[r];return this.context.relatedMetricsSingleAction=(0,l.mergeLists)(this.context.relatedMetricsSingleAction,t),this}},{key:"build",value:function(){return new b(this.context)}}]),e}())},8142:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(9713)),c=n(r(1171)),s=n(r(7700)),u=r(5607),l=r(8184),f=r(5742),d=r(1582),h=function(e){console.error("Error publishing metrics:"),console.error(e)},p=function(){function e(t){var r=this,n=arguments.length>1&&void 0!==arguments[1]?arguments[1]:h,o=arguments.length>2&&void 0!==arguments[2]?arguments[2]:new s.default;if((0,i.default)(this,e),(0,a.default)(this,"combinedErrorHandler",(function(e){try{r.errorHandler(e)}catch(t){console.error("Error handling error publishing metrics:"),console.error(t),h(e)}})),o instanceof s.default.Builder)throw new Error("KatalMetricsContext.Builder object passed instead of KatalMetricsContext.  Try calling .build() method.");this.driver=t,this.errorHandler=n,this.context=o instanceof s.default?o:new s.default(o)}return(0,o.default)(e,[{key:"withErrorHandling",value:function(e){try{return e()}catch(t){this.combinedErrorHandler(t)}}},{key:"getAdditionalRelatedMetrics",value:function(e){var t=e instanceof s.default?e.context:e,r=this.getBaseRelatedMetrics();return(0,l.mergeLists)(r,t.relatedMetrics)}},{key:"getBaseRelatedMetrics",value:function(){return(0,l.mergeLists)(this.context.context.relatedMetrics,this.context.context.relatedMetricsSingleAction)}},{key:"publish",value:function(e){var t=this;this.withErrorHandling((function(){if(!e)throw new Error("Cannot publish undefined/null metric object");if(u.Object.Types.List===e.type)e.metricList.forEach((function(e){t.publish(e)}));else{var r=t.context.driverContext(),n=r.validationError();if(n)throw n;var i=e.validationError();if(i)throw i;(0,f.dispatchMetricEvent)(e,r),t.driver.publish(e,r)}}))}},{key:"newChildPublisher",value:function(t){return new e(this.driver,this.errorHandler,this.context.merge(t))}},{key:"newChildActionPublisher",value:function(t){var r=this._generateActionid(t),n=this.context.withoutRelatedMetricsSingleAction().merge({actionId:r}).merge(t),i=new e(this.driver,this.errorHandler,n),o=!t||t instanceof s.default.Builder?this.getBaseRelatedMetrics():this.getAdditionalRelatedMetrics(t);return o&&o.forEach((function(e){i.publish(e)})),i}},{key:"newChildActionPublisherChained",value:function(e){var t=this._generateActionid(e),r=(0,d.embedRequestId)(t,this.context.context.requestId),n=[new u.String("parentActionId",r)],i=new s.default({actionId:t,relatedMetricsSingleAction:n}).merge(e);return this.newChildActionPublisher(i)}},{key:"newChildActionPublisherChainedForMethod",value:function(e,t){return this.newChildActionPublisherChained(new s.default({methodName:e}).merge(t))}},{key:"newChildActionPublisherForMethod",value:function(e,t){return this.newChildActionPublisher(new s.default({methodName:e}).merge(t))}},{key:"newChildActionPublisherForInitialization",value:function(e){return this.newChildActionPublisherForMethod("Initialization",e)}},{key:"publishString",value:function(e,t){this.publish(new u.String(e,t))}},{key:"publishStringTruncate",value:function(e,t){var r=new u.String(e,t);r.truncate=!0,this.publish(r)}},{key:"publishCounter",value:function(e,t){this.publish(new u.Counter(e,t))}},{key:"publishTimer",value:function(e,t){this.publish(new u.Timer(e,t))}},{key:"publishCounterMonitor",value:function(e,t){this.publish(new u.Counter(e,t).withMonitor())}},{key:"publishTimerMonitor",value:function(e,t){this.publish(new u.Timer(e,t).withMonitor())}},{key:"_generateActionid",value:function(e){if(e){var t=function(e){return e.context?e.context:e}(e);if(t.actionId)return t.actionId}return(0,c.default)()}}]),e}();t.default=p},5274:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_ERROR_HANDLER=void 0;t.DEFAULT_ERROR_HANDLER=function(e){throw e}},4864:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=function(){function e(){(0,i.default)(this,e)}return(0,o.default)(e,[{key:"publish",value:function(e,t){throw new Error("KatalMetricsDriver is an abstract class, please choose a driver and use that instead")}}]),e}();t.default=a},2721:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){var r=void 0;return e.some((function(e){return null!=(r=t(e))})),r}},469:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var r=Object.values?Object.values:function(e){return Object.keys(e).map((function(t){return e[t]}))};t.default=r},8059:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){if("number"!=typeof e)return new Error("Expected ".concat(t," to have type 'number', but it was type '").concat((0,i.default)(e),"'"));if(e<0)return new Error("Expected ".concat(t," to be positive, but it was ").concat(e));if(!o(e))return new Error("Expected ".concat(t," to be an integer, but it was ").concat(e))};var i=n(r(8)),o=function(e){return isFinite(e)&&Math.floor(e)===e}},1051:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e,t){if("string"!=typeof e)return new Error("Expected ".concat(t," to be a string, but it was a ").concat((0,i.default)(e)));if(e.length>a)return new Error("Expected ".concat(t," to be less than ").concat(a," characters, but it was ").concat(e.length," characters"));if(e.length<1)return new Error("Expected ".concat(t," to be non-blank"));if(!o.test(e))return new Error("Expected ".concat(t," to contain only valid characters, but it was ").concat(e,".  It can only contain letters, numbers, and these symbols: .:@_/-"))};var i=n(r(8)),o=/^[A-Za-z0-9.:@_/-]+$/,a=127},1582:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.embedRequestId=function(e,t){if(t)return[t,e].join("::");return e}},8184:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.mergeLists=function(e,t){return e||t?[].concat((0,i.default)(e||[]),(0,i.default)(t||[])):void 0};var i=n(r(319))},5742:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.dispatchMetricEvent=function(e,t){if("undefined"==typeof window)return;(function(e,t){if("function"!=typeof CustomEvent)return;var r=new CustomEvent("katal.metrics.publish",{detail:{metric:e,context:t.getFields()}});window.dispatchEvent(r)})(e,t),function(e,t){var r=window.__KATAL_METRICS_EXTENSION__;r&&r.publish(e,t.getFields())}(e,t)}},5292:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=function(e){return(0,i.default)(e,(function(e){return function(e,t){if(e.length>c)return new Error("Expected Dimension name for value ".concat(t," to be ").concat(c," characters or less, but it was ").concat(e.length," characters"));if(e.length<1)return new Error("Expected Dimension name for value ".concat(t," to be non-blank"));if(!o.test(e))return new Error("Expected Dimension name for value ".concat(t," to contain only ASCII characters, but it was ").concat(e));if(!a.test(e))return new Error("Expected Dimension name for value ".concat(t," to contain at least one non whitespace character, but it was ").concat(e));if(e.startsWith(":"))return new Error("Expected Dimension name for value ".concat(t,' to not start with a colon (":"), but it was ').concat(e));if(t.length>s)return new Error("Expected Dimension value for name ".concat(e," to be ").concat(s," characters or less, but it was ").concat(t.length," characters"));if(t.length<1)return new Error("Expected Dimension value for name ".concat(e," to be non-blank"));if(!o.test(t))return new Error("Expected Dimension value for name ".concat(e," to contain only ASCII characters, but it was ").concat(t));if(!a.test(t))return new Error("Expected Dimension value for name ".concat(e," to contain at least one non whitespace character, but it was ").concat(t,"}"))}(e.name,e.value)}))};var i=n(r(2721)),o=/^[\x20-\x7E]+$/,a=/^.*\S+.*$/,c=255,s=1024},5989:(e,t,r)=>{"use strict";var n=r(5318),i=r(8);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"CloudWatchDimensions",{enumerable:!0,get:function(){return l.CloudWatchDimensions}}),Object.defineProperty(t,"Context",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(t,"ErrorHandler",{enumerable:!0,get:function(){return u.ErrorHandler}}),t.Metric=void 0,Object.defineProperty(t,"MetricsDriver",{enumerable:!0,get:function(){return s.default}}),Object.defineProperty(t,"Publisher",{enumerable:!0,get:function(){return a.default}});var o=function(e,t){if(!t&&e&&e.__esModule)return e;if(null===e||"object"!==i(e)&&"function"!=typeof e)return{default:e};var r=f(t);if(r&&r.has(e))return r.get(e);var n={},o=Object.defineProperty&&Object.getOwnPropertyDescriptor;for(var a in e)if("default"!==a&&Object.prototype.hasOwnProperty.call(e,a)){var c=o?Object.getOwnPropertyDescriptor(e,a):null;c&&(c.get||c.set)?Object.defineProperty(n,a,c):n[a]=e[a]}n.default=e,r&&r.set(e,n);return n}(r(5607));t.Metric=o;var a=n(r(8142)),c=n(r(7700)),s=n(r(4864)),u=r(5274),l=r(1128);function f(e){if("function"!=typeof WeakMap)return null;var t=new WeakMap,r=new WeakMap;return(f=function(e){return e?r:t})(e)}},199:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(6525)),c=n(r(2205)),s=n(r(8585)),u=n(r(9754)),l=n(r(8116)),f=n(r(8059));function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,s.default)(this,r)}}var h=function(e){(0,c.default)(r,e);var t=d(r);function r(e){var n,o=arguments.length>1&&void 0!==arguments[1]?arguments[1]:0;return(0,i.default)(this,r),(n=t.call(this,e)).value=o,n}return(0,o.default)(r,[{key:"value",get:function(){return this._value},set:function(e){this._value=Math.round(e)}},{key:"type",get:function(){return l.default.Types.Counter}},{key:"add",value:function(e){this.value+=e}},{key:"canMonitor",get:function(){return!0}},{key:"validationError",value:function(){var e=(0,a.default)((0,u.default)(r.prototype),"validationError",this).call(this);return e||(0,f.default)(this.value,"field value in Counter metrics object '".concat(this.name,"'"))}}]),r}(l.default);t.default=h},6673:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(2205)),c=n(r(8585)),s=n(r(9754)),u=n(r(9713)),l=n(r(4053)),f=n(r(2545));function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,s.default)(e);if(t){var i=(0,s.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,c.default)(this,r)}}var h=function(e){(0,a.default)(r,e);var t=d(r);function r(e){return(0,i.default)(this,r),t.call(this,"".concat(r.HTTP_REQUEST_PREFIX,".").concat(e))}return(0,o.default)(r,[{key:"url",get:function(){return this.getNamedMetricValue(r.URL_SUFFIX)},set:function(e){this.setOrDeleteNamedMetricValue(r.URL_SUFFIX,f.default,e)}},{key:"urlMetric",get:function(){return this.getNamedMetric(r.URL_SUFFIX)}},{key:"statusCode",get:function(){return this.getNamedMetricValue(r.STATUS_CODE_SUFFIX)},set:function(e){this.setOrDeleteNamedMetricValue(r.STATUS_CODE_SUFFIX,f.default,e)}},{key:"statusCodeMetric",get:function(){return this.getNamedMetric(r.STATUS_CODE_SUFFIX)}},{key:"statusText",get:function(){return this.getNamedMetricValue(r.STATUS_TEXT_SUFFIX)},set:function(e){this.setOrDeleteNamedMetricValue(r.STATUS_TEXT_SUFFIX,f.default,e)}},{key:"statusTextMetric",get:function(){return this.getNamedMetric(r.STATUS_TEXT_SUFFIX)}}]),r}(l.default);t.default=h,(0,u.default)(h,"HTTP_REQUEST_PREFIX","HTTPRequest"),(0,u.default)(h,"URL_SUFFIX","URL"),(0,u.default)(h,"STATUS_CODE_SUFFIX","StatusCode"),(0,u.default)(h,"STATUS_TEXT_SUFFIX","StatusText")},21:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(2205)),a=n(r(8585)),c=n(r(9754)),s=n(r(9713));function u(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,c.default)(e);if(t){var i=(0,c.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,a.default)(this,r)}}var l=function(e){(0,o.default)(r,e);var t=u(r);function r(){return(0,i.default)(this,r),t.call(this,r.INITIALIZE_METRIC_NAME)}return r}(n(r(4053)).default);t.default=l,(0,s.default)(l,"INITIALIZE_METRIC_NAME","Initialization")},8981:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(2205)),c=n(r(8585)),s=n(r(9754)),u=n(r(124)),l=n(r(469));function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,s.default)(e);if(t){var i=(0,s.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,c.default)(this,r)}}var d=function(e){(0,a.default)(r,e);var t=f(r);function r(e){var n;return(0,i.default)(this,r),(n=t.call(this,e)).namedMetrics={},n}return(0,o.default)(r,[{key:"metricList",get:function(){return(0,l.default)(this.namedMetrics)}},{key:"setNamedMetric",value:function(e,t){var r=t(this.getNameForSubMetric(e));r.canMonitor&&(r.isMonitor=this.isMonitor),this.namedMetrics[e]=r}},{key:"setOrDeleteNamedMetricValue",value:function(e,t,r){null==r?this.deleteNamedMetric(e):this.getOrCreateNamedMetric(e,(function(e){return new t(e,r)})).value=r}},{key:"getOrCreateNamedMetric",value:function(e,t){return this.namedMetrics[e]||this.setNamedMetric(e,t),this.namedMetrics[e]}},{key:"getNamedMetric",value:function(e){return this.namedMetrics[e]}},{key:"deleteNamedMetric",value:function(e){delete this.namedMetrics[e]}},{key:"getNamedMetricValue",value:function(e){var t=this.getNamedMetric(e);if(t)return t.value}},{key:"getNameForSubMetric",value:function(e){return"".concat(this.name,".").concat(e)}}]),r}(u.default);t.default=d},8116:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(8)),o=n(r(4575)),a=n(r(3913)),c=n(r(9713)),s=n(r(1051)),u=n(r(2952)),l=function(){function e(t){(0,o.default)(this,e),this._name=t,this._isMonitor=!1}return(0,a.default)(e,[{key:"name",get:function(){return this._name}},{key:"metricKey",get:function(){return this._name}},{key:"withMonitor",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0];return this.isMonitor=e,this}},{key:"isMonitor",get:function(){return this._isMonitor},set:function(e){this._isMonitor=!!e}},{key:"canMonitor",get:function(){throw new Error("Subclass of KatalMetricObject must implement canMonitor")}},{key:"type",get:function(){throw new Error("Subclass of KatalMetricObject must implement type getter")}},{key:"validationError",value:function(){return void 0!==this.isMonitor&&"boolean"!=typeof this.isMonitor?new Error("Field isMonitor should be a boolean, but it was a ".concat((0,i.default)(this.isMonitor))):(0,s.default)(this.name,"field name")}}]),e}();t.default=l,(0,c.default)(l,"Types",u.default)},124:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(6525)),c=n(r(2911)),s=n(r(2205)),u=n(r(8585)),l=n(r(9754)),f=n(r(8116)),d=n(r(2721));function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,l.default)(e);if(t){var i=(0,l.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,u.default)(this,r)}}var p=function(e){(0,s.default)(r,e);var t=h(r);function r(e){return(0,i.default)(this,r),t.call(this,e)}return(0,o.default)(r,[{key:"metricList",get:function(){throw new Error("Subclass of KatalMetricObjectList must implement metricList getter")}},{key:"isMonitor",get:function(){return(0,a.default)((0,l.default)(r.prototype),"isMonitor",this)},set:function(e){(0,c.default)((0,l.default)(r.prototype),"isMonitor",e,this,!0),this.metricList.forEach((function(t){t.canMonitor&&(t.isMonitor=e)}))}},{key:"canMonitor",get:function(){return!0}},{key:"type",get:function(){return f.default.Types.List}},{key:"validationError",value:function(){return(0,d.default)(this.metricList,(function(e){return e.validationError()}))}}]),r}(f.default);t.default=p},2545:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(8)),o=n(r(4575)),a=n(r(3913)),c=n(r(1506)),s=n(r(6525)),u=n(r(2205)),l=n(r(8585)),f=n(r(9754)),d=n(r(9713)),h=n(r(8116));function p(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,f.default)(e);if(t){var i=(0,f.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,l.default)(this,r)}}var v=function(e){(0,u.default)(r,e);var t=p(r);function r(e,n){var i;return(0,o.default)(this,r),i=t.call(this,e),(0,d.default)((0,c.default)(i),"truncate",!1),i.value=n,i}return(0,a.default)(r,[{key:"value",get:function(){return this._value},set:function(e){"number"!=typeof e&&"boolean"!=typeof e||(e=e.toString()),this._value=e}},{key:"type",get:function(){return h.default.Types.String}},{key:"canMonitor",get:function(){return!1}},{key:"validationError",value:function(){var e=(0,s.default)((0,f.default)(r.prototype),"validationError",this).call(this);if(e)return e;if("string"!=typeof this.value)return new Error("Expected field value in String metrics object '".concat(this.name,"' to be type string, but it was ").concat((0,i.default)(this.value)));if(this.value.length>r.MAX_SIZE){if(!this.truncate)return new Error("Expected field value in String metrics object '".concat(this.name,"' to be ").concat(r.MAX_SIZE," characters or less, but it was ").concat(this.value.length," characters."));this.value=this.value.substring(0,r.MAX_SIZE)}}}]),r}(h.default);t.default=v,(0,d.default)(v,"MAX_SIZE",256)},4053:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(2205)),c=n(r(8585)),s=n(r(9754)),u=n(r(9713)),l=n(r(8981)),f=n(r(4392)),d=n(r(199));function h(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,s.default)(e);if(t){var i=(0,s.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,c.default)(this,r)}}var p=function(e){(0,a.default)(r,e);var t=h(r);function r(e){var n;return(0,i.default)(this,r),(n=t.call(this,e)).setNamedMetric(r.LATENCY_SUFFIX,(function(e){return new f.default(e)})),n.setNamedMetric(r.FAILURE_SUFFIX,(function(e){return new d.default(e,1)})),n}return(0,o.default)(r,[{key:"setFailure",value:function(){var e=!(arguments.length>0&&void 0!==arguments[0])||arguments[0]?1:0;this.failureMetric.value=e}},{key:"setSuccess",value:function(){this.setFailure(!1)}},{key:"setLatency",value:function(e){this.latencyMetric.value=e}},{key:"latencyMetric",get:function(){return this.getNamedMetric(r.LATENCY_SUFFIX)}},{key:"failureMetric",get:function(){return this.getNamedMetric(r.FAILURE_SUFFIX)}}]),r}(l.default);t.default=p,(0,u.default)(p,"LATENCY_SUFFIX","Latency"),(0,u.default)(p,"FAILURE_SUFFIX","Failure")},1741:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(6525)),c=n(r(2205)),s=n(r(8585)),u=n(r(9754)),l=n(r(8116)),f=n(r(8059));function d(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,u.default)(e);if(t){var i=(0,u.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,s.default)(this,r)}}var h=function(e){(0,c.default)(r,e);var t=d(r);function r(e,n){var o;return(0,i.default)(this,r),(o=t.call(this,e)).value=n,o}return(0,o.default)(r,[{key:"value",get:function(){return this._value},set:function(e){this._value=null!=e?Math.round(e):e}},{key:"type",get:function(){return l.default.Types.Timer}},{key:"canMonitor",get:function(){return!0}},{key:"validationError",value:function(){var e=(0,a.default)((0,u.default)(r.prototype),"validationError",this).call(this);return e||(0,f.default)(this.value,"field value in Timer metrics object '".concat(this.name,"'"))}}]),r}(l.default);t.default=h},4392:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0;var i=n(r(4575)),o=n(r(3913)),a=n(r(2911)),c=n(r(6525)),s=n(r(2205)),u=n(r(8585)),l=n(r(9754));function f(e){var t=function(){if("undefined"==typeof Reflect||!Reflect.construct)return!1;if(Reflect.construct.sham)return!1;if("function"==typeof Proxy)return!0;try{return Boolean.prototype.valueOf.call(Reflect.construct(Boolean,[],(function(){}))),!0}catch(e){return!1}}();return function(){var r,n=(0,l.default)(e);if(t){var i=(0,l.default)(this).constructor;r=Reflect.construct(n,arguments,i)}else r=n.apply(this,arguments);return(0,u.default)(this,r)}}var d=function(e){(0,s.default)(r,e);var t=f(r);function r(e,n){var o;return(0,i.default)(this,r),(o=t.call(this,e,void 0)).start(n),o._value=void 0,o}return(0,o.default)(r,[{key:"start",value:function(e){this._startTime=e||this.now()}},{key:"stop",value:function(e){return this._stopTime=e||this.now()}},{key:"isStopped",get:function(){return void 0!==this._stopTime}},{key:"value",get:function(){return void 0===(0,c.default)((0,l.default)(r.prototype),"value",this)&&(this.isStopped||this.stop(),(0,a.default)((0,l.default)(r.prototype),"value",this.stopTime-this.startTime,this,!0)),(0,c.default)((0,l.default)(r.prototype),"value",this)},set:function(e){(0,a.default)((0,l.default)(r.prototype),"value",e,this,!0)}},{key:"startTime",get:function(){return this._startTime}},{key:"stopTime",get:function(){return this._stopTime}},{key:"now",value:function(){return performance.now()}}]),r}(n(r(1741)).default);t.default=d},2952:(e,t)=>{"use strict";var r;Object.defineProperty(t,"__esModule",{value:!0}),t.default=void 0,function(e){e.String="String",e.Counter="Counter",e.Timer="Timer",e.List="List"}(r||(r={}));var n=r;t.default=n},5607:(e,t,r)=>{"use strict";var n=r(5318);Object.defineProperty(t,"__esModule",{value:!0}),Object.defineProperty(t,"Counter",{enumerable:!0,get:function(){return a.default}}),Object.defineProperty(t,"HttpRequest",{enumerable:!0,get:function(){return f.default}}),Object.defineProperty(t,"Initialization",{enumerable:!0,get:function(){return l.default}}),Object.defineProperty(t,"Object",{enumerable:!0,get:function(){return i.default}}),Object.defineProperty(t,"String",{enumerable:!0,get:function(){return o.default}}),Object.defineProperty(t,"TimedAttempt",{enumerable:!0,get:function(){return u.default}}),Object.defineProperty(t,"Timer",{enumerable:!0,get:function(){return c.default}}),Object.defineProperty(t,"TimerStopwatch",{enumerable:!0,get:function(){return s.default}});var i=n(r(8116)),o=n(r(2545)),a=n(r(199)),c=n(r(1741)),s=n(r(4392)),u=n(r(4053)),l=n(r(21)),f=n(r(6673))},1128:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0})},1154:function(e,t){"use strict";var r,n,i=this&&this.__awaiter||function(e,t,r,n){return new(r||(r=Promise))((function(i,o){function a(e){try{s(n.next(e))}catch(t){o(t)}}function c(e){try{s(n.throw(e))}catch(t){o(t)}}function s(e){var t;e.done?i(e.value):(t=e.value,t instanceof r?t:new r((function(e){e(t)}))).then(a,c)}s((n=n.apply(e,t||[])).next())}))},o=this&&this.__generator||function(e,t){var r,n,i,o,a={label:0,sent:function(){if(1&i[0])throw i[1];return i[1]},trys:[],ops:[]};return o={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(o[Symbol.iterator]=function(){return this}),o;function c(o){return function(c){return function(o){if(r)throw new TypeError("Generator is already executing.");for(;a;)try{if(r=1,n&&(i=2&o[0]?n.return:o[0]?n.throw||((i=n.return)&&i.call(n),0):n.next)&&!(i=i.call(n,o[1])).done)return i;switch(n=0,i&&(o=[2&o[0],i.value]),o[0]){case 0:case 1:i=o;break;case 4:return a.label++,{value:o[1],done:!1};case 5:a.label++,n=o[1],o=[0];continue;case 7:o=a.ops.pop(),a.trys.pop();continue;default:if(!(i=a.trys,(i=i.length>0&&i[i.length-1])||6!==o[0]&&2!==o[0])){a=0;continue}if(3===o[0]&&(!i||o[1]>i[0]&&o[1]<i[3])){a.label=o[1];break}if(6===o[0]&&a.label<i[1]){a.label=i[1],i=o;break}if(i&&a.label<i[2]){a.label=i[2],a.ops.push(o);break}i[2]&&a.ops.pop(),a.trys.pop();continue}o=t.call(e,a)}catch(c){o=[6,c],n=0}finally{r=i=0}if(5&o[0])throw o[1];return{value:o[0]?o[1]:void 0,done:!0}}([o,c])}}};Object.defineProperty(t,"__esModule",{value:!0}),t.KatalWebSellerCentralClient=t.WeblabRegionType=t.WeblabType=void 0,function(e){e.Session="session",e.Customer="customer",e.Merchant="merchant",e.User="user",e.Partner="partner",e.Vendor="vendor"}(r=t.WeblabType||(t.WeblabType={})),function(e){e.HostMarketplace="host_marketplace",e.Region="region"}(n=t.WeblabRegionType||(t.WeblabRegionType={}));var a=function(){function e(e){var t;this.options=e,this.weblabPath="/mons/weblabs",(null===(t=this.options)||void 0===t?void 0:t.weblabPath)&&(this.weblabPath=this.options.weblabPath)}return e.prototype.setMetricsPublisher=function(e){this.metricsPublisher=e},e.prototype.getTreatments=function(e){var t=this,r=e;return this.verifySellerCentralWeblab(r).then((function(){var n=t.getWeblabApiUrls(r);return t.getTreatmentData(n).then((function(r){if(!Object.keys(r).length)throw new Error("Unable to contact the Mons weblab service to retrieve weblab treatments.");var n=new Map;return e.forEach((function(e){var i,o,a=(null===(i=r[e.id])||void 0===i?void 0:i.treatment)||e.defaultTreatment,c=!(null===(o=r[e.id])||void 0===o?void 0:o.treatment),s=t.convertToTreatment(e,a,c);n.set(e,s)})),n}))}))},e.prototype.recordTrigger=function(e,t){var r=this,n=e,i=this.getRecordTriggerApiData(n,t);return this.verifySellerCentralWeblab([n]).then((function(){return fetch(i.url,{method:"post",headers:{Accept:"application/json","Content-Type":"application/json"},body:JSON.stringify(i.body)})})).then((function(e){if(r.publishPerformanceTimerForUrl(e.url,"RecordTrigger.Network"),!e.ok)throw new Error("Unable to contact the weblab service [".concat(i.url,"] to record weblab triggers. Status: ").concat(e.status," Message: ").concat(e.statusText))}))},e.prototype.verifySellerCentralWeblab=function(e){var t=this;return e.filter((function(e){return!e.weblabType||t.isNotSupportedByNewApi(e)})).length?Promise.reject(new Error("Invalid weblab type found or marketplaceId is missing. All weblabs must be of type SellerCentralWeblab or you must provide marketplaceId for partner account.")):Promise.resolve()},e.prototype.convertWeblabToGetRequestFormat=function(e){var t=this.getWeblabMarketplaceType(e),r=encodeURIComponent("".concat(e.id,":").concat(e.weblabType,":").concat(t));return"weblab=".concat(r)},e.prototype.convertToTreatment=function(e,t,r){var n=this;return{weblabId:e.id,treatmentValue:t,assignmentMissing:!!r,recordTrigger:r?function(){return Promise.resolve()}:function(){return n.recordTrigger(e,t)}}},e.prototype.randomId=function(){return Math.floor(1e8*Math.random())},e.prototype.getRequestDuration=function(e){if(null===performance||void 0===performance?void 0:performance.getEntriesByName){var t=performance.getEntriesByName(e);if(null==t?void 0:t.length)return t[0].duration}},e.prototype.publishPerformanceTimerForUrl=function(e,t){if(this.metricsPublisher){var r=this.getRequestDuration(e);r&&this.metricsPublisher.publishTimerMonitor("".concat(t,".Latency"),r)}},e.prototype.getWeblabApiUrls=function(e){var t=this,r={};return e.forEach((function(e){t.updateUrlToQueryParamMapping(e,r)})),Object.keys(r).map((function(e){return"".concat(e,"?").concat(r[e].join("&"),"&reqid=").concat(t.randomId())}))},e.prototype.updateUrlToQueryParamMapping=function(e,t){if(this.doFallbackToOldApi(e))t[this.weblabPath]=(t[this.weblabPath]||[]).concat(this.convertWeblabToGetRequestFormat(e));else{var r="/mons/weblabs/".concat(e.weblabType,"/treatment");t[r]=(t[r]||[]).concat(this.convertWeblabToNewGetRequestFormat(e))}},e.prototype.doFallbackToOldApi=function(e){var t;return!!(null===(t=this.options)||void 0===t?void 0:t.weblabPath)||(e.weblabType===r.Session||e.weblabType===r.Customer)&&this.isMarketplaceIdRequiredAndNotPresent(e)},e.prototype.isMarketplaceIdRequiredAndNotPresent=function(e){return this.getWeblabMarketplaceType(e)===n.HostMarketplace&&!e.marketplaceId},e.prototype.convertWeblabToNewGetRequestFormat=function(e){var t=this.getWeblabMarketplaceType(e),r=encodeURIComponent("".concat(e.id,":").concat(t).concat(e.marketplaceId?":".concat(e.marketplaceId):""));return"weblab=".concat(r)},e.prototype.getTreatmentData=function(e){return i(this,void 0,void 0,(function(){var t,r,n=this;return o(this,(function(i){switch(i.label){case 0:return[4,Promise.allSettled(e.map((function(e){return fetch(e).then((function(e){return n.publishPerformanceTimerForUrl(e.url,"GetTreatments.Network"),e.json()}))})))];case 1:return t=i.sent(),r={},t.forEach((function(e){"fulfilled"===e.status?e.value.treatments?Object.assign(r,e.value.treatments):n.publishCountMetric("".concat(e.value.path,".Error")):n.publishCountMetric("ApiNetworkError")})),[2,r]}}))}))},e.prototype.publishCountMetric=function(e){this.metricsPublisher&&this.metricsPublisher.publishCounterMonitor(e,1)},e.prototype.getRecordTriggerApiData=function(e,t){var r=this.getWeblabMarketplaceType(e);return this.doFallbackToOldApi(e)?{url:"".concat(this.weblabPath,"/").concat(e.id,"/trigger/").concat(t,"?weblabType=").concat(e.weblabType,"&marketplaceType=").concat(r,"&reqid=").concat(this.randomId())}:{url:"/mons/weblabs/".concat(e.weblabType,"/trigger?reqid=").concat(this.randomId()),body:{weblabId:e.id,treatmentId:t,marketplaceType:r,marketplaceId:e.marketplaceId||null}}},e.prototype.getWeblabMarketplaceType=function(e){return e.regionType||n.HostMarketplace},e.prototype.isNotSupportedByNewApi=function(e){return[r.Partner].includes(e.weblabType)&&this.isMarketplaceIdRequiredAndNotPresent(e)},e}();t.KatalWebSellerCentralClient=a},6196:function(e,t,r){"use strict";var n,i=this&&this.__extends||(n=function(e,t){return n=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},n(e,t)},function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}n(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)});Object.defineProperty(t,"__esModule",{value:!0}),t.MonsWeblabTaskClient=void 0;var o=function(e){function t(){return null!==e&&e.apply(this,arguments)||this}return i(t,e),t.prototype.getTreatments=function(t){var r=this;return e.prototype.verifySellerCentralWeblab.call(this,t).then((function(){var n,i,o=null===(n=null===document||void 0===document?void 0:document.head)||void 0===n?void 0:n.querySelector('meta[name="a2z:mons_weblab_treatment"]'),a=(null===(i=null==o?void 0:o.content)||void 0===i?void 0:i.split(","))||[],c=new Map;a.forEach((function(e){var t=e.split("=",2),r=t[0],n=t[1];r&&n&&c.set(r,n)}));var s=new Map;return t.map((function(t){var n=c.get(t.id),i=!n,o=n||t.defaultTreatment;s.set(t,e.prototype.convertToTreatment.call(r,t,o,i))})),s}))},t}(r(1154).KatalWebSellerCentralClient);t.MonsWeblabTaskClient=o},340:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.createBrowserStorageCache=void 0;var n=r(9846);t.createBrowserStorageCache=function(e,t){void 0===t&&(t=600);var r=window.ue_mid||void 0;return new n.BrowserStorageCache(e,t,r)}},4103:function(e,t,r){"use strict";var n=this&&this.__createBinding||(Object.create?function(e,t,r,n){void 0===n&&(n=r);var i=Object.getOwnPropertyDescriptor(t,r);i&&!("get"in i?!t.__esModule:i.writable||i.configurable)||(i={enumerable:!0,get:function(){return t[r]}}),Object.defineProperty(e,n,i)}:function(e,t,r,n){void 0===n&&(n=r),e[n]=t[r]}),i=this&&this.__exportStar||function(e,t){for(var r in e)"default"===r||Object.prototype.hasOwnProperty.call(t,r)||n(t,e,r)};Object.defineProperty(t,"__esModule",{value:!0}),i(r(1154),t),i(r(6196),t),i(r(340),t)},377:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0}),t.DEFAULT_ERROR_HANDLER=function(){}},3705:function(e,t,r){"use strict";var n=this&&this.__assign||function(){return n=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},n.apply(this,arguments)},i=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var o=i(r(6595)),a=r(5989),c=r(9457),s=r(377),u=r(2918),l={cacheRefreshRateSeconds:600},f=function(){function e(e){this.weblabProxy=e.weblabProxy,this.errorHandler=e.errorHandler||s.DEFAULT_ERROR_HANDLER,e.metricsPublisher&&(this.metricsPublisher=e.metricsPublisher.newChildActionPublisherForMethod("KatalWeblab"),this.weblabProxy.setMetricsPublisher&&this.weblabProxy.setMetricsPublisher(this.metricsPublisher)),e.treatmentCache&&(this.cache=e.treatmentCache,this.cacheSettings=n(n({},l),e.cacheBehavior),this.cacheRefresher=new c.CacheRefresher(e.treatmentCache,this.cacheSettings,this.weblabProxy,this.errorHandler,this.metricsPublisher),this.cacheRefresher.run())}return e.prototype.getTreatment=function(e){if(!e||!e.id||!e.defaultTreatment)throw new Error("Invalid input: getTreatment must be passed a Weblab object");return this.getTreatments([e]).then((function(t){return t[e.id]}))},e.prototype.getTreatments=function(e){if(!e||!Array.isArray(e))throw new Error("Invalid input: getTreatments must be passed an array of Weblab objects");var t;t=this.cache?this.loadTreatmentsFromCache(e):this.getTreatmentsOrFallbackToDefaultValues(e);var r={};return t.then((function(e){return e.forEach((function(e){r[e.weblabId]=e})),r}))},e.prototype.triggerWeblab=function(e,t){var r,n,i=this;if(!(null===(r=t)||void 0===r?void 0:r.treatmentValue)||(null===(n=t)||void 0===n?void 0:n.assignmentMissing))return o.default.resolve();var c=new a.Metric.TimedAttempt("RecordTrigger.Promise").withMonitor();return this.weblabProxy.recordTrigger(e,t.treatmentValue).then((function(){c.setSuccess(),i.publishMetricsIfExists((function(e){return e.publish(c)}))})).catch((function(e){throw c.setFailure(),i.publishMetricsIfExists((function(e){return e.publish(c)})),e}))},e.prototype.loadTreatmentsFromCache=function(e){var t=this;return new o.default((function(r){var n=t.getTreatmentsFromCache(e),i=n.foundTreatments;if(!n.missingTreatments.length)return t.publishMetricsIfExists((function(e){e.publishCounterMonitor("TreatmentsCacheHit",1)})),void r(i);t.publishMetricsIfExists((function(e){e.publishCounterMonitor("TreatmentsCacheHit",0)})),t.getTreatmentsOrFallbackToDefaultValues(e).then((function(e){r(e)}))}))},e.prototype.getTreatmentsFromCache=function(e){var t=this,r=[],n=[],i=u.readWeblabCookie();return e.forEach((function(e){var o=e.id in i?void 0:t.cache.getTreatment(e.id);o?r.push(t.convertCachableTreatmentToTreatment(e,o)):n.push(t.convertWeblabToDefaultTreatment(e))})),{foundTreatments:r,missingTreatments:n}},e.prototype.publishMetricsIfExists=function(e){this.metricsPublisher&&e(this.metricsPublisher)},e.prototype.convertCachableTreatmentToTreatment=function(e,t){var r=this;return n(n({},t),{recordTrigger:function(){return r.triggerWeblab(e,t)}})},e.prototype.getTreatmentsOrFallbackToDefaultValues=function(e){var t=this,r=new a.Metric.TimedAttempt("GetTreatments.Promise").withMonitor();return this.weblabProxy.getTreatments(e).then((function(e){r.setSuccess(),t.publishMetricsIfExists((function(e){e.publish(r)}));var n=[];return e.forEach((function(e){n.push(e)})),t.updateCache(e),n})).catch((function(n){return r.setFailure(),t.publishMetricsIfExists((function(e){e.publish(r)})),t.errorHandler(n),e.map((function(e){return t.convertWeblabToDefaultTreatment(e)}))}))},e.prototype.convertWeblabToDefaultTreatment=function(e){return this.convertCachableTreatmentToTreatment(e,{treatmentValue:e.defaultTreatment,weblabId:e.id})},e.prototype.updateCache=function(e){var t=this;this.cache&&e.forEach((function(e,r){t.cache.addTreatment(e,r)}))},e}();t.KatalWeblabClient=f},8720:(e,t)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var r=function(){function e(e,t,r){this.applicationName=e,this.ttl=t,this.namespace=r,this.cacheKey="Weblabs."+this.applicationName+(this.namespace?"."+this.namespace:"")}return e.prototype.getCachedWeblabs=function(){var e=this,t=[],r=this.getCachedData(),n=!1;return Object.keys(r.treatmentMap).forEach((function(i){var o=r.treatmentMap[i];e.isExpired(o)?(n=!0,delete r.treatmentMap[i]):t.push(o.weblab)})),n&&this.writeCachedData(r),t},e.prototype.getTreatment=function(e){var t=this.getCachedData().treatmentMap[e];if(t&&!this.isExpired(t))return t.treatment},e.prototype.addTreatment=function(e,t){var r=e.weblabId,n=this.getCachedData(),i=this.getExpirationTime();n.treatmentMap[r]={treatment:e,weblab:t,expirationTime:i},this.writeCachedData(n)},e.prototype.hasTreatment=function(e){var t=this.getCachedData(),r=t.treatmentMap[e];return null!=t.treatmentMap[e]&&!this.isExpired(r)},e.prototype.clearTreatment=function(e){var t=this.getCachedData();t.treatmentMap[e]&&(delete t.treatmentMap[e],this.writeCachedData(t))},e.prototype.clearAllTreatments=function(){sessionStorage.removeItem(this.cacheKey)},e.prototype.getExpirationTime=function(){var e=1e3*this.ttl;return(new Date).getTime()+e},e.prototype.isExpired=function(e){var t=(new Date).getTime();return e.expirationTime<=t},e.prototype.getCachedData=function(){var e=sessionStorage.getItem(this.cacheKey);return e?JSON.parse(e):{treatmentMap:{}}},e.prototype.writeCachedData=function(e){var t=JSON.stringify(e);sessionStorage.setItem(this.cacheKey,t)},e}();t.BrowserStorageCache=r},9457:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(5989),i=function(){function e(e,t,r,n,i){this.treatmentCache=e,this.cacheSettings=t,this.client=r,this.errorHandler=n,this.publisher=i}return e.prototype.run=function(){var e=this,t=1e3*this.cacheSettings.cacheRefreshRateSeconds;setInterval((function(){var t=e.treatmentCache.getCachedWeblabs();if(t.length){var r=new n.Metric.TimedAttempt("GetTreatments").withMonitor();e.client.getTreatments(t).then((function(t){r.setSuccess(),e.publishMetricsIfExists((function(e){e.publish(r)}));var n=[];t.forEach((function(t,r){var i=e.treatmentCache.getTreatment(r.id);i&&i.treatmentValue===t.treatmentValue||(e.treatmentCache.addTreatment(t,r),n.push(t))})),e.cacheSettings.cacheListener&&n.length>0&&e.cacheSettings.cacheListener(n)})).catch((function(t){r.setFailure(),e.publishMetricsIfExists((function(e){e.publish(r)})),e.errorHandler(t)}))}}),t)},e.prototype.publishMetricsIfExists=function(e){this.publisher&&e(this.publisher)},e}();t.CacheRefresher=i},6693:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(8720);t.BrowserStorageCache=n.BrowserStorageCache},7840:function(e,t,r){"use strict";var n=this&&this.__importDefault||function(e){return e&&e.__esModule?e:{default:e}};Object.defineProperty(t,"__esModule",{value:!0});var i=n(r(6595)),o=function(){function e(e){this.treamentSettings=e}return e.prototype.setMetricsPublisher=function(){},e.prototype.getTreatments=function(e){var t=this,r=new Map;return e.forEach((function(e){var n=t.treamentSettings[e.id];r.set(e,{weblabId:e.id,treatmentValue:n,recordTrigger:function(){return t.recordTrigger(e,n)}})})),i.default.resolve(r)},e.prototype.recordTrigger=function(e,t){return i.default.resolve()},e}();t.TestWeblabClient=o},2918:function(e,t){"use strict";var r=this&&this.__assign||function(){return r=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var i in t=arguments[r])Object.prototype.hasOwnProperty.call(t,i)&&(e[i]=t[i]);return e},r.apply(this,arguments)};Object.defineProperty(t,"__esModule",{value:!0});function n(e){return e?e.replace(/["']/g,"").split("&").reduce((function(e,t){var n,i=t.split(":"),o=i[0],a=i[1];return o&&a?r(r({},e),((n={})[o.trim()]=a.trim(),n)):e}),{}):{}}function i(e){if("undefined"!=typeof document&&void 0!==document.cookie){var t=document.cookie.match("(^|[^;]+)\\s*"+e+"\\s*=\\s*([^;]+)");return t?t.pop():void 0}}t.parseWeblabCookie=n,t.readWeblabCookie=function(){var e=i("experiment");return e?n(e):{}},t.readCookie=i},9846:(e,t,r)=>{"use strict";Object.defineProperty(t,"__esModule",{value:!0});var n=r(3705);t.KatalWeblabClient=n.KatalWeblabClient;var i=r(6693);t.BrowserStorageCache=i.BrowserStorageCache;var o=r(7840);t.TestWeblabClient=o.TestWeblabClient},7228:e=>{e.exports=function(e,t){(null==t||t>e.length)&&(t=e.length);for(var r=0,n=new Array(t);r<t;r++)n[r]=e[r];return n}},3646:(e,t,r)=>{var n=r(7228);e.exports=function(e){if(Array.isArray(e))return n(e)}},1506:e=>{e.exports=function(e){if(void 0===e)throw new ReferenceError("this hasn't been initialised - super() hasn't been called");return e}},4575:e=>{e.exports=function(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}},3913:e=>{function t(e,t){for(var r=0;r<t.length;r++){var n=t[r];n.enumerable=n.enumerable||!1,n.configurable=!0,"value"in n&&(n.writable=!0),Object.defineProperty(e,n.key,n)}}e.exports=function(e,r,n){return r&&t(e.prototype,r),n&&t(e,n),e}},9713:e=>{e.exports=function(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}},6525:(e,t,r)=>{var n=r(8331);function i(t,r,o){return"undefined"!=typeof Reflect&&Reflect.get?e.exports=i=Reflect.get:e.exports=i=function(e,t,r){var i=n(e,t);if(i){var o=Object.getOwnPropertyDescriptor(i,t);return o.get?o.get.call(r):o.value}},i(t,r,o||t)}e.exports=i},9754:e=>{function t(r){return e.exports=t=Object.setPrototypeOf?Object.getPrototypeOf:function(e){return e.__proto__||Object.getPrototypeOf(e)},t(r)}e.exports=t},2205:(e,t,r)=>{var n=r(9489);e.exports=function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Super expression must either be null or a function");e.prototype=Object.create(t&&t.prototype,{constructor:{value:e,writable:!0,configurable:!0}}),t&&n(e,t)}},5318:e=>{e.exports=function(e){return e&&e.__esModule?e:{default:e}}},6860:e=>{e.exports=function(e){if("undefined"!=typeof Symbol&&Symbol.iterator in Object(e))return Array.from(e)}},8206:e=>{e.exports=function(){throw new TypeError("Invalid attempt to spread non-iterable instance.\nIn order to be iterable, non-array objects must have a [Symbol.iterator]() method.")}},8585:(e,t,r)=>{var n=r(8),i=r(1506);e.exports=function(e,t){return!t||"object"!==n(t)&&"function"!=typeof t?i(e):t}},2911:(e,t,r)=>{var n=r(8331),i=r(9713);function o(e,t,r,a){return o="undefined"!=typeof Reflect&&Reflect.set?Reflect.set:function(e,t,r,o){var a,c=n(e,t);if(c){if((a=Object.getOwnPropertyDescriptor(c,t)).set)return a.set.call(o,r),!0;if(!a.writable)return!1}if(a=Object.getOwnPropertyDescriptor(o,t)){if(!a.writable)return!1;a.value=r,Object.defineProperty(o,t,a)}else i(o,t,r);return!0},o(e,t,r,a)}e.exports=function(e,t,r,n,i){if(!o(e,t,r,n||e)&&i)throw new Error("failed to set property");return r}},9489:e=>{function t(r,n){return e.exports=t=Object.setPrototypeOf||function(e,t){return e.__proto__=t,e},t(r,n)}e.exports=t},8331:(e,t,r)=>{var n=r(9754);e.exports=function(e,t){for(;!Object.prototype.hasOwnProperty.call(e,t)&&null!==(e=n(e)););return e}},319:(e,t,r)=>{var n=r(3646),i=r(6860),o=r(379),a=r(8206);e.exports=function(e){return n(e)||i(e)||o(e)||a()}},8:e=>{function t(r){return"function"==typeof Symbol&&"symbol"==typeof Symbol.iterator?e.exports=t=function(e){return typeof e}:e.exports=t=function(e){return e&&"function"==typeof Symbol&&e.constructor===Symbol&&e!==Symbol.prototype?"symbol":typeof e},t(r)}e.exports=t},379:(e,t,r)=>{var n=r(7228);e.exports=function(e,t){if(e){if("string"==typeof e)return n(e,t);var r=Object.prototype.toString.call(e).slice(8,-1);return"Object"===r&&e.constructor&&(r=e.constructor.name),"Map"===r||"Set"===r?Array.from(e):"Arguments"===r||/^(?:Ui|I)nt(?:8|16|32)(?:Clamped)?Array$/.test(r)?n(e,t):void 0}}},6595:(e,t,r)=>{"use strict";r.r(t),r.d(t,{default:()=>p});const n=function(e){var t=this.constructor;return this.then((function(r){return t.resolve(e()).then((function(){return r}))}),(function(r){return t.resolve(e()).then((function(){return t.reject(r)}))}))};var i=setTimeout;function o(e){return Boolean(e&&void 0!==e.length)}function a(){}function c(e){if(!(this instanceof c))throw new TypeError("Promises must be constructed via new");if("function"!=typeof e)throw new TypeError("not a function");this._state=0,this._handled=!1,this._value=void 0,this._deferreds=[],h(e,this)}function s(e,t){for(;3===e._state;)e=e._value;0!==e._state?(e._handled=!0,c._immediateFn((function(){var r=1===e._state?t.onFulfilled:t.onRejected;if(null!==r){var n;try{n=r(e._value)}catch(i){return void l(t.promise,i)}u(t.promise,n)}else(1===e._state?u:l)(t.promise,e._value)}))):e._deferreds.push(t)}function u(e,t){try{if(t===e)throw new TypeError("A promise cannot be resolved with itself.");if(t&&("object"==typeof t||"function"==typeof t)){var r=t.then;if(t instanceof c)return e._state=3,e._value=t,void f(e);if("function"==typeof r)return void h((n=r,i=t,function(){n.apply(i,arguments)}),e)}e._state=1,e._value=t,f(e)}catch(o){l(e,o)}var n,i}function l(e,t){e._state=2,e._value=t,f(e)}function f(e){2===e._state&&0===e._deferreds.length&&c._immediateFn((function(){e._handled||c._unhandledRejectionFn(e._value)}));for(var t=0,r=e._deferreds.length;t<r;t++)s(e,e._deferreds[t]);e._deferreds=null}function d(e,t,r){this.onFulfilled="function"==typeof e?e:null,this.onRejected="function"==typeof t?t:null,this.promise=r}function h(e,t){var r=!1;try{e((function(e){r||(r=!0,u(t,e))}),(function(e){r||(r=!0,l(t,e))}))}catch(n){if(r)return;r=!0,l(t,n)}}c.prototype.catch=function(e){return this.then(null,e)},c.prototype.then=function(e,t){var r=new this.constructor(a);return s(this,new d(e,t,r)),r},c.prototype.finally=n,c.all=function(e){return new c((function(t,r){if(!o(e))return r(new TypeError("Promise.all accepts an array"));var n=Array.prototype.slice.call(e);if(0===n.length)return t([]);var i=n.length;function a(e,o){try{if(o&&("object"==typeof o||"function"==typeof o)){var c=o.then;if("function"==typeof c)return void c.call(o,(function(t){a(e,t)}),r)}n[e]=o,0==--i&&t(n)}catch(s){r(s)}}for(var c=0;c<n.length;c++)a(c,n[c])}))},c.resolve=function(e){return e&&"object"==typeof e&&e.constructor===c?e:new c((function(t){t(e)}))},c.reject=function(e){return new c((function(t,r){r(e)}))},c.race=function(e){return new c((function(t,r){if(!o(e))return r(new TypeError("Promise.race accepts an array"));for(var n=0,i=e.length;n<i;n++)c.resolve(e[n]).then(t,r)}))},c._immediateFn="function"==typeof setImmediate&&function(e){setImmediate(e)}||function(e){i(e,0)},c._unhandledRejectionFn=function(e){"undefined"!=typeof console&&console&&console.warn("Possible Unhandled Promise Rejection:",e)};const p=c},5327:e=>{for(var t=[],r=0;r<256;++r)t[r]=(r+256).toString(16).substr(1);e.exports=function(e,r){var n=r||0,i=t;return[i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],"-",i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]],i[e[n++]]].join("")}},5217:e=>{var t="undefined"!=typeof crypto&&crypto.getRandomValues&&crypto.getRandomValues.bind(crypto)||"undefined"!=typeof msCrypto&&"function"==typeof window.msCrypto.getRandomValues&&msCrypto.getRandomValues.bind(msCrypto);if(t){var r=new Uint8Array(16);e.exports=function(){return t(r),r}}else{var n=new Array(16);e.exports=function(){for(var e,t=0;t<16;t++)0==(3&t)&&(e=4294967296*Math.random()),n[t]=e>>>((3&t)<<3)&255;return n}}},1171:(e,t,r)=>{var n=r(5217),i=r(5327);e.exports=function(e,t,r){var o=t&&r||0;"string"==typeof e&&(t="binary"===e?new Array(16):null,e=null);var a=(e=e||{}).random||(e.rng||n)();if(a[6]=15&a[6]|64,a[8]=63&a[8]|128,t)for(var c=0;c<16;++c)t[o+c]=a[c];return t||i(a)}}},t={};function r(n){var i=t[n];if(void 0!==i)return i.exports;var o=t[n]={exports:{}};return e[n].call(o.exports,o,o.exports,r),o.exports}r.d=(e,t)=>{for(var n in t)r.o(t,n)&&!r.o(e,n)&&Object.defineProperty(e,n,{enumerable:!0,get:t[n]})},r.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),r.r=e=>{"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},(()=>{"use strict";function e(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}class t{constructor(t,r){e(this,"window",void 0),e(this,"handlers",void 0),this.window=t,this.handlers=r}init(){this.window.addEventListener("message",(e=>{if(this.window.origin!=e.origin)return;if(!e.data.source||"Vibes"!=e.data.source)return;if(!e.data.action)throw new Error("Event posted to Vibes sent to without valid action");const t=e.data.args;if(!Array.isArray(t))throw new Error("Action ".concat(e.data.action," posted to Vibes sent to without valid args"));e.data.action in this.handlers?this.handlers[e.data.action](...t):this.handlers.default(...t)}))}}function n(e,t){var r=Object.keys(e);if(Object.getOwnPropertySymbols){var n=Object.getOwnPropertySymbols(e);t&&(n=n.filter((function(t){return Object.getOwnPropertyDescriptor(e,t).enumerable}))),r.push.apply(r,n)}return r}function i(t){for(var r=1;r<arguments.length;r++){var i=null!=arguments[r]?arguments[r]:{};r%2?n(Object(i),!0).forEach((function(r){e(t,r,i[r])})):Object.getOwnPropertyDescriptors?Object.defineProperties(t,Object.getOwnPropertyDescriptors(i)):n(Object(i)).forEach((function(e){Object.defineProperty(t,e,Object.getOwnPropertyDescriptor(i,e))}))}return t}const o=(e,t)=>{window.vibesState=i(i({},window.vibesState||{}),{},{[e]:t})};function a(e,t){window.ueLogError?window.ueLogError(e,{logLevel:"ERROR",attribution:"Vibes",message:t}):console.error(t,e)}let c=function(e){return e.dismissed="Vibes.CustomerDismissed",e.submitted="Vibes.CustomerSubmitted",e.formWillShow="Vibes.UI.SurveyFormWillShow",e.formWasShown="Vibes.UI.SurveyFormWasShown",e.eligible="Vibes.UI.CustomerIsEligible",e.notEligible="Vibes.UI.CustomerIsNotEligible",e.formOffScreen="Vibes.UI.FormOffScreen",e.targetingDecisionFromCache="Vibes.UI.DecisionFromCache",e.targetingDecisionFromAPI="Vibes.UI.DecisionFromAPI",e.refusedToTarget="Vibes.UI.RefusedToTarget",e}({});class s{constructor(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e(this,"host",void 0),e(this,"csrfToken",void 0),this.host=t,this.csrfToken=r}async saveEvent(e,t){(await fetch("".concat(this.host,"/gp/vibes/api/events"),{method:"POST",redirect:"error",headers:{Accept:"application/json","Content-Type":"application/json","anti-csrftoken-a2z":this.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({workflow:t,eventName:e})})).ok||a("Error saving Event to Vibes API","Unable to save event ".concat(e," for workflow ").concat(t))}}function u(e,t){const r=t.querySelector('meta[name="'.concat(e,'"]'));return r&&r.getAttribute("content")||""}function l(e){return u("a2z:mons_app_name",e)}function f(e){return u("a2z:mons_site_name",e)}function d(e){return u("anti-csrftoken-a2z",e)}function h(){const e=window.parent.location;return"".concat(e.protocol,"//").concat(e.host).concat(e.pathname)}function p(e){const t="a2z:vibesTreatment",r=e.getElementById(t);return r?r.getAttribute("value")||"":u(t,e)}class v{constructor(t,r){e(this,"modal",void 0),e(this,"title",void 0),this.modal=t,this.title=r}handlers(){var e=this;return{"vibes-open":function(){(arguments.length<=0?void 0:arguments[0])&&(e.title.innerText=arguments.length<=0?void 0:arguments[0]),e.modal.classList.add("vibes-modal-visible"),o("targeting",!0),setTimeout((()=>{const e=document.getElementById("vibes-modal-window");if(e){const t=e.getBoundingClientRect();if(t.y&&t.y<0){new s("",d(window.document)).saveEvent(c.formOffScreen,"NO_WORKFLOW").catch((e=>{window.ueLogError&&window.ueLogError(e,{logLevel:"ERROR",attribution:"Vibes",message:"Unexpected error saving form display event"})}))}}}),0)},"vibes-close":()=>{this.modal.classList.remove("vibes-modal-visible")},"vibes-refused-targeting":()=>{o("targeting",!1)},default:()=>{}}}}b=window;var b;const m=1209600,y=3600;const g="VIBES_DESKTOP";class w{constructor(t){let r=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";e(this,"host",void 0),e(this,"csrfToken",void 0),this.host=t,this.csrfToken=r}async getQuestion(e){try{const t=await fetch("".concat(this.host,"/pulse/v1/question"),{method:"POST",redirect:"error",headers:{Accept:"application/json","Content-Type":"application/json","anti-csrftoken-a2z":this.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({runtimeAttributes:{mons_site:f(document),mons_app:l(document),weblab:e},surveyClient:g})});return t.ok?await t.json():(a("Error getting question for seller","Error getting question for seller"),null)}catch(t){return a(t,"Error while fetching Pulse GetQuestion API"),null}}async submitResponse(e,t,r,n,i){try{const o=await fetch("".concat(this.host,"/pulse/v1/response"),{method:"POST",redirect:"error",headers:{Accept:"application/json","Content-Type":"application/json","anti-csrftoken-a2z":this.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({questionId:e,surveyClient:g,textResponse:r,rating:t,responseMetadata:{mons_site:f(i),mons_app:l(i),url:h(),targeting_event_id:n}})});return o.ok?await o.json():(a("Error submitting question response","Error submitting question response"),null)}catch(o){return a(o,"Error while calling Pulse SubmitResponse API"),null}}async registerEvent(e,t,r,n){try{(await fetch("".concat(this.host,"/pulse/v1/event"),{method:"POST",redirect:"error",headers:{Accept:"application/json","Content-Type":"application/json","anti-csrftoken-a2z":this.csrfToken,"X-Requested-With":"XMLHttpRequest"},body:JSON.stringify({questionId:e,surveyClient:g,eventType:t,eventMetadata:{mons_site:f(n),mons_app:l(n),url:h(),targeting_event_id:r}})})).ok||a("Error submitting event","Error submitting question response")}catch(i){a(i,"Error while calling Pulse RegisterEvent API")}}}class T{constructor(t,r){e(this,"storage",void 0),e(this,"metricsRepo",void 0),this.storage=t,r&&(this.metricsRepo=r)}trackWorkflow(e,t){const r=Date.now()+1e3*t;this.storage.setItem("vibes:".concat(e),r.toString()),this.metricsRepo&&this.metricsRepo.workflowTrackingEvent(e)}getWorkflowList(){const e=Object.keys(this.storage),t=[];for(const r of e)if(r.startsWith("vibes:")){const e=r.substr(6);this.isWorkflowRecent(e)||t.push(e)}return t}hasWorkflow(e){const t=this.storage.getItem("vibes:".concat(e));if(!t)return!1;const r=parseInt(t);return!(!r||r<Date.now())||(this.storage.removeItem("vibes:".concat(e)),!1)}getWorkflowTTL(e){const t=this.storage.getItem("vibes:".concat(e));if(!t)return!1;const r=parseInt(t);return!r||r<Date.now()?(this.storage.removeItem("vibes:".concat(e)),!1):r}isWorkflowRecent(e){const t=this.getWorkflowTTL(e);if(!t)return!1;const r=t-1e3*m;return Date.now()-r<1e3*y}getRateOverride(){const e=this.storage.getItem("vibes-rate-override");return!!e&&parseFloat(e)}saveAskMeLater(e,t,r){if("pulse"===e&&r){new w("",d(window.parent.document)).registerEvent(r,"DEFERRED",window.parent.pulseEventId,window.parent.document)}const n={time:(Date.now()+1e3*t).toString(),workflow:e};this.storage.setItem("vibes-aml",JSON.stringify(n)),this.metricsRepo&&this.metricsRepo.askLaterEvent(e)}saveDismiss(e,t,r){if("pulse"===e&&r){new w("",d(t)).registerEvent(r,"DISMISSED",window.parent.pulseEventId,t)}this.storage.setItem("vibes-dismiss",Date.now().toString()),this.metricsRepo&&this.metricsRepo.dismissedEvent(e)}getAskMeLater(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t="vibes-aml",r=this.storage.getItem(t);if(e&&this.storage.removeItem(t),!r)return null;let n;try{n=JSON.parse(r)}catch(i){return this.storage.removeItem(t),null}return"object"==typeof n&&Object.prototype.hasOwnProperty.call(n,"time")&&Object.prototype.hasOwnProperty.call(n,"workflow")?n:(this.storage.removeItem(t),null)}customerWasTargeted(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]&&arguments[2];this.metricsRepo&&this.metricsRepo.customerTargetedEvent(e,t,r)}hasDismissedWithin(e){return this.checkKey("vibes-dismiss",e)}hasSubmittedWithin(e){return this.checkKey("vibes-submit",e)}saveSubmission(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.storage.setItem("vibes-submit",Date.now().toString()),this.metricsRepo&&this.metricsRepo.submittedEvent(e,t)}saveFormInteraction(e){let t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"";this.metricsRepo&&this.metricsRepo.formInteractionEvent(e,t)}checkKey(e,t){const r=this.storage.getItem(e);if(!r)return!1;const n=parseInt(r);if(!n)return this.storage.removeItem(e),!1;return Date.now()-n<1e3*t||(this.storage.removeItem(e),!1)}}const _="vibes_host.774f81bd.css";class E{constructor(t,r){e(this,"host",void 0),e(this,"cache",void 0),this.host=t,this.cache=r}async isEligible(){const e=this.cache.get("vibes-cache:eligibility");if(e)return"true"===e;const t=await fetch("".concat(this.host,"/gp/vibes/api/eligibility"),{redirect:"error",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!t.ok)return!1;let r;try{r=await t.json()}catch(i){throw new Error("Could not parse eligibility response body, status code: ".concat(t.status))}if(!("can_target"in r)||!("ttl"in r))throw new Error("Vibes eligibility response missing can_target or ttl information");const n=r.can_target?"true":"false";return r.can_target||this.cache.set("vibes-cache:eligibility",n,r.ttl),r.can_target}}class M{constructor(t){e(this,"storage",void 0),this.storage=t}get(e){const t=this.storage.getItem(e);if(!t)return null;let r;try{r=JSON.parse(t)}catch(n){throw new Error("Could not parse cache entry: ".concat(t))}return(new Date).getTime()>r.exp?(this.storage.removeItem(e),null):r.value}set(e,t,r){const n={value:t,exp:(new Date).getTime()+r};this.storage.setItem(e,JSON.stringify(n))}getJson(e){const t=this.get(e);return t?JSON.parse(t):null}setJson(e,t,r){const n=JSON.stringify(t);this.set(e,n,r)}}class O{constructor(t,r,n,i,o){e(this,"targetingService",void 0),e(this,"eligibilityService",void 0),e(this,"cache",void 0),e(this,"repo",void 0),e(this,"eventService",void 0),this.targetingService=t,this.eligibilityService=r,this.cache=n,this.repo=i,this.eventService=o}getAskMeLaterDecision(){let e=arguments.length>0&&void 0!==arguments[0]&&arguments[0];const t=this.repo.getAskMeLater(e);if(!t)return{workflow:"",target:!1,continueTargeting:!0};if(Date.now()>=t.time){this.repo.customerWasTargeted(t.workflow);return{workflow:t.workflow.startsWith("vibes:")?t.workflow.substr(6):t.workflow,target:!0,continueTargeting:!0}}return{workflow:"",target:!1,continueTargeting:!1}}async shouldTarget(){const e="vibes-cache:targeting",t=this.getAskMeLaterDecision(!0);if(t.target)return[t.workflow,!0];if(!t.continueTargeting)return[!1,!1];let r=!1,n=this.cache.getJson(e);if(n&&(r=!0),!n){const t=await this.targetingService.getTargetingInfo();n={name:t.name,sample_rate:t.sample_rate},this.cache.setJson(e,n,t.ttl)}if(!n.name||!n.sample_rate)return[!1,!1];if(!(Math.random()<=n.sample_rate)){return Math.random()<=.01&&await this.eventService.saveEvent(c.refusedToTarget,n.name),[!1,!1]}this.cache.setJson(e,{name:null,sample_rate:0},3e5);if(!(await this.eligibilityService.isEligible()))return[!1,!1];const i=r?c.targetingDecisionFromCache:c.targetingDecisionFromAPI;return await this.eventService.saveEvent(i,n.name),[n.name,!1]}}class S{constructor(t){e(this,"host",void 0),this.host=t}async getTargetingInfo(){const e=await fetch("".concat("","/gp/vibes/api/survey"),{redirect:"error",headers:{Accept:"application/json","X-Requested-With":"XMLHttpRequest"}});if(!e.ok)throw new Error("Received a non-200 status from Targeting API with status: ".concat(e.status," - ").concat(e.statusText));let t;try{t=await e.json()}catch(n){throw new Error("Could not parse targeting response body, status code: ".concat(e.status))}const r=Object.keys(t);if(!r.includes("name")||!r.includes("ttl")||!r.includes("sample_rate"))throw new Error("Received invalid response body from Targeting API with status code ".concat(e.status));return t}}var k=r(9846);var P=r(4103);const R=new P.KatalWebSellerCentralClient,C=new k.KatalWeblabClient({weblabProxy:R}),I={EligibilityApiLaunch:{defaultTreatment:"C",id:"VIBES_ELEGIBILITY_API_LAUNCH_415878",weblabType:P.WeblabType.Customer},PulseApiLaunch:{defaultTreatment:"C",id:"PULSE_984652",weblabType:P.WeblabType.Merchant}},x=new class{constructor(t,r){e(this,"config",void 0),e(this,"client",void 0),this.config=t,this.client=r}async getTreatment(e){if(!(e in this.config))throw new Error("Weblab ".concat(e.toString()," is not provided in config"));const t=this.config[e];try{const r=await this.client.getTreatment(t);return r.treatmentValue?r.treatmentValue:(a("Null treatment value found for Weblab.","Null treatment value found for Weblab:\n                 ".concat(e.toString(),". Returning default treatment: ").concat(t.defaultTreatment,".")),t.defaultTreatment)}catch(r){a(r,"Vibes could not fetch treatment for weblab ".concat(e.toString()))}return t.defaultTreatment}}(I,C);async function j(e,t,r,n){const i="T3"===await async function(){return"complete"===document.readyState||"interactive"===document.readyState?p(window.document):new Promise((e=>{document.addEventListener("readystatechange",(t=>{const r=t.target.readyState;"complete"!==r&&"interactive"!==r||e(p(window.document))}))}))}()?"experimental-treatment":"default-treatment",o=document.createElement("div");o.id="vibes-modal-container";const a=document.createElement("div");a.id="vibes-modal-window",a.classList.add(i),a.setAttribute("tab-index","-1"),a.setAttribute("aria-role","dialog"),a.setAttribute("aria-modal","true"),a.setAttribute("aria-labeledby","vibes-modal-title");const c=document.createElement("div");c.id="vibes-modal-header";const s=document.createElement("h3");s.id="vibes-modal-title",s.innerText="We love feedback!";const u=document.createElement("button");u.id="vibes-close-button",u.innerHTML='<span class="vibes-close-button-caption">Close</span>';const l=document.createElement("div");l.id="vibes-modal-content";const f=document.createElement("iframe");f.id="vibes-modal-iframe";let d="".concat("/gp/vibes/form","?w=").concat(e);r&&(d="".concat("/gp/vibes/form","?w=pulse"),window.pulseQuestion=r),n&&(window.pulseEventId=n),t&&(d+="&askMeLater=true"),f.src=d,l.appendChild(f),c.appendChild(s),c.appendChild(u),a.appendChild(c),a.appendChild(l),o.appendChild(a);const h=t=>{f.contentWindow&&f.contentWindow.postMessage({action:"close",source:"Vibes",args:[e]},"*"),(null!=t?t:o).classList.remove("vibes-modal-visible")};return u.addEventListener("click",(()=>{h()})),a.addEventListener("keydown",(e=>{"Escape"===e.code&&h()})),o.addEventListener("click",(e=>{const t=e.target;"vibes-modal-container"===t.id&&h(t)})),[o,f,s]}async function A(e,r,n,i){const o=(a=document,u="https://d1qhz7cfyjhrcf.cloudfront.net",l=_,new Promise(((e,t)=>{const r=a.createElement("link");r.onload=()=>e(),r.onerror=e=>t(e),r.setAttribute("rel","stylesheet"),r.setAttribute("href","".concat(u,"/").concat(l)),a.getElementsByTagName("head")[0].appendChild(r)})));var a,u,l;const[f,h,p]=await j(e,r,n,i),b=new v(f,p),m=new t(window,b.handlers());await o,function(e,t,r){e.addEventListener("close",(()=>{t.contentWindow&&t.contentWindow.postMessage({action:"close",source:"Vibes",args:[r]},"*")})),document.body.appendChild(e)}(f,h,e),m.init(),function(e){(async()=>{try{const t=new s("",d(window.document));await t.saveEvent(c.formWillShow,e)}catch(t){window.ueLogError&&window.ueLogError(t,{logLevel:"ERROR",attribution:"Vibes",message:"Unexpected error saving form display event"})}})()}(e)}async function F(){const e="vendorCentralPlatform"===function(){const e=f(document);return"sellerCentral"===e?"sellerCentralPlatform":"vendorCentral"===e?"vendorCentralPlatform":""}()?null:x.getTreatment("PulseApiLaunch"),t=new M(window.localStorage),r=new O(new S(""),new E("",t),t,new T(window.localStorage),new s("","")),n=null==e?"T2":await e;if(["T1","T2","T3"].includes(n)){if(t.get("pulse-cooldown"))return;const e=new w("",d(window.document)),r=await e.getQuestion(n);return void(r&&r.question&&(t.set("pulse-cooldown","true",36e5),await A("pulse",r.isInCooldown,r.question,r.eventTargetingId||null)))}const[i,o]=await r.shouldTarget();i&&await A(i,o,null,null)}async function D(){try{const e=window.location.search,t=new URLSearchParams(e),r=t.get("debugVibesWorkflow"),n=t.get("debugVibesAskMeLater");if(r)return void(await A(r,!!n,null,null));console.log("Initializing Vibes Host File"),window.vibesState={},await F()}catch(e){window.ueLogError?window.ueLogError(e,{logLevel:"ERROR",attribution:"Vibes",message:"Unexpected exception caught while running Vibes"}):console.error("Error initializing Vibes host: ",e)}}!async function(){await D()}()})()})();
//# sourceMappingURL=vibes_host.6459bb9a.js.map